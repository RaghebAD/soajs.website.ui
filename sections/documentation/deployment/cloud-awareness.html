<a id="cloud-awareness"></a>
<h1>Cloud with Awareness</h1>
<div class="white-container">
	<p>
		SOAJS is cloud ready by design, from day one we designed SOAJS to be multi environment, multi project and multi configuration. Ideally if you want to build a product, you want to have the following enviornments:
	</p>
	<ul>
		<li>Development</li>
		<li>Staging</li>
		<li>QA</li>
		<li>Production</li>
	</ul>
	<p>You do not need a cloud deployment for your development environment, please checkout <a href="#/documentation/deployment/development">The Development Environment</a> deployment for this purpose. For the remaining environments, this is how the deployment should look like.<br/>
		<img ng-src="images/documentation/deployment-cloud1.png"/><br/>
		In the above image, you will see a dashboard environment where the remaining three other environments pull their provisioning information from its data layer. This is done in a way to centralize and make it easy to manage the environments.<br/>
	</p>
	<hr/>
	<img ng-src="images/documentation/deployment-cloud2.png" class="image-right"/>

	<p>
		Before we start explaining how to do the cloud deployment, let us go over the different layers you have in every environment:
	</p>
	<ol>
		<li><b>DNS</b>: You will use the DNS load balance to balance among the multiple Nginx deployment whether their in the same data center or in separate data centers distributed geographically. You can use something like <a href="http://www.dyn.com" target="_blank">DynDns</a> for this purpose.
		</li>
		<li><b>Nginx</b>: This layer is the front end layer of your deployment and redirects traffic using upstream into SOAJS controllers.</li>
		<li><b>Controller</b>: This layer works closely with HAproxy to create awareness and forwards requests towards the SOAJS services layer.</li>
		<li><b>Services</b>: This layer consist of one or many cloud each serving one or many service. Also if needed, this layer works closely with HAproxy to create awareness.</li>
		<li><b>Data Layer</b>: This is the data layer where information is being stored. This layer can be configured as a replica set and can be sharded as well.</li>
	</ol>
	<br/>

	<p>
		We will explain how to build the Dashboard and the Production Environments since Staging and QA environments are an exact replica with less instances from the Production.
	</p>
	<p>
		The Dashboard and Production environments have the same layers as explained above, the only difference is at the services layer where for dashboard we will install soajs.urac an soajs.dasboard, and for production we will install soajs.urac and soaj.oauth and soajs.examples to be able to run
		some tests.<br/>
	</p>
	<br/>
	<hr/>
	<h3>Requirement:</h3>
	<table class="myTable" width="100%">
		<thead>
			<tr>
				<th>Layer Name</th>
				<th>Number of instances</th>
				<th>Hostname</th>
			</tr>
		</thead>
		<tr class="odd">
			<td>Nginx</td>
			<td>3</td>
			<td>nginx_01, nginx_02, nginx_03</td>
		</tr>
		<tr class="even">
			<td>Controller</td>
			<td>3</td>
			<td>controller_01, controller_02, controller_03</td>
		</tr>
		<tr class="odd">
			<td>Services</td>
			<td>3</td>
			<td>services_01, services_02, services_03</td>
		</tr>
		<tr class="even">
			<td>Data</td>
			<td>2</td>
			<td>data_01, data_02</td>
		</tr>
	</table>
	<p>
		The above table illustrates the different layers with the number of instances and their corresponding hostnames.<br/>
		In summary to build the dashboard environment, you will need 11 instances and for the production environment you will also need 11 instances.<br/>
		<em><u>Note:</u> Please note you can always combine layers and reduce the number of instances.</em>
	</p>
	<br/>
	<table width="100%" class="myTable">
		<thead>
			<tr>
				<th>Environment Name</th>
				<th>Domain</th>
			</tr>
		</thead>
		<tr>
			<td>Dashboard</td>
			<td>dashboard.soajs.org<br/>dashboard-api.soajs.org</td>
		</tr>
		<tr class="even">
			<td>Staging</td>
			<td>staging-api.soajs.org</td>
		</tr>
		<tr>
			<td>QA</td>
			<td>qa-api.soajs.org</td>
		</tr>
		<tr class="even">
			<td>Production</td>
			<td>api.soajs.org</td>
		</tr>
	</table>
	<p>
		The above table illustrates the corresponding subdomains used per environment. However you can have different domains and subdomains per environment and this can be configured at the <a href="#/documentation/core/registry">Registry</a>.
	</p>
	<br/>
	<hr/>

	<h2>Installation</h2>

	<h3>Nginx Layer</h3>

	<div>
		<h4>Docker:</h4>

		<p>
			Our team has prepared a docker image that contains all services installed and configured and ready to run to speed things up for you. Simply install docker on the machine, then using docker, install and run the layer you need.<br/>
			Start by installing NodeJs then navigate to <a href="https://docs.docker.com/installation/" target="_blank">Docker Installation Page</a> and install docker and <a href="https://docs.docker.com/compose/" target="_blank">docker-compose</a> on the machine you are using. <br/>
			Once NodeJs, Docker and Docker-Compose are installed, install soajs.utilities to pull the configuration files:
		</p>
		<pre><code class="bash">$ cd /opt/soajs/node_modules/
$ npm install soajs.utilities</code></pre>
		<p>
			soajs.utilities contains 2 docker configuration files for the nginx layer:<br/>
		</p>
		<table width="100%" class="myTable">
			<thead>
				<tr>
					<th>Environment</th>
					<th>Docker File Path</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>Dashboard</td>
					<td>soajs.utilities/deployment/cloud/dashboard/nginx/Dockerfile</td>
				</tr>
				<tr class="even">
					<td>Production</td>
					<td>soajs.utilities/deployment/cloud/prod/nginx/Dockerfile</td>
				</tr>
			</tbody>
		</table>
		<br/>
		<pre><code class="bash"># on dashboard nginx layer
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/dashboard/nginx/
$ docker-compose up

# on prod nginx layer
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/prod/nginx/
$ docker-compose up</code></pre>
		<p>
			Docker will load the configuration file <b>docker-compose.yml</b> and install and run the nginx machines for you.<br/>
			<u>Note:</u> If you have chosen to install Nginx via Docker, <a href="" ng-click="scrollToDiv('cloud-awareness-controller', 70)">Click Here</a> to skip the manual installation of Nginx and head to the next step.
		</p>
		<hr/>
		<br/>
		<h4>Manual Installation:</h4>

		<p>
			Start by setting up 3 Machines for Dashboard Nginx Layer and 3 Machines for Production Nginx Layer.<br/>
			Install Node, Nginx and soajs.utilities on each of these machines:
		</p>
		<pre><code class="bash"># install Nginx latest stable version
$ apt-get install nginx

# install nodejs
$ apt-get install nodejs

# create directory path for soajs modules
$ mkdir -p /opt/soajs/node_modules

$ cd /opt/soajs/node_modules/

# install soajs.utitlites
$ npm install soajs.utitlies</code></pre>
		<p>
			When Nginx is installed, locate its configuration file; On Ubuntu the configuration file is located in /etc/nginx/ folder,
			and copy the nginx configuration files from soajs.utilities to that location:
		</p>
		<p><b>Dashboard Nginx configuration:</b></p>
		<pre><code class="javascript"># copy the upstream.conf
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/dashboard/nginx/FILES/
$ cp nginx/upstream.conf /etc/nginx/conf.d/

# copy the hosts
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/dashboard/nginx/FILES/
$ cp nginx/conf/*.conf /etc/nginx/sites-enabled/</code></pre>
		<p><b>Production Nginx configuration:</b></p>
		<pre><code class="javascript"># copy the upstream.conf
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/prod/nginx/FILES/
$ cp nginx/upstream.conf /etc/nginx/conf.d/

# copy the hosts
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/prod/nginx/FILES/
$ cp nginx/conf/*.conf /etc/nginx/sites-enabled/</code></pre>
		<p>
			Next, edit the hosts file of each Nginx machine and add the following:
		</p>
		<pre><code class="bash"># edit /etc/hosts of each nginx machine
$ sudo gedit /etc/hosts

# add these lines in /etc/hosts
192.168.0.1 controller_01
192.168.0.2 controller_02
192.168.0.3 controller_03</code></pre>
		<p>
			You will need to put the right IP addresses above for both Nginx machines.<br/>
			Start Nginx:
		</p>
		<pre><code class="bash"># start Nginx
$ sudo nginx</code></pre>
	</div>
	<br/>
	<hr/>
	<h3 id="cloud-awareness-controller">Controllers Layer</h3>

	<div>
		<h4>Docker:</h4>

		<p>
			As mentioned in the above Nginx layer docker installation, our team has prepared a docker image that contains all services installed and configured and ready to run to speed things up for you. Simply install NodeJs, Docker and Docker Compose on the machine, then using docker, install and
			run this layer. Once NodeJs, Docker and Docker-Compose are installed, install soajs.utilities to pull the configuration files:
		</p>
		<pre><code class="bash">$ cd /opt/soajs/node_modules/
$ npm install soajs.utilities</code></pre>
		<p>
			soajs.utilities contains 2 docker configuration files for the controllers:<br/>
		</p>
		<table width="100%" class="myTable">
			<thead>
				<tr>
					<th>Environment</th>
					<th>Docker File Path</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>Dashboard</td>
					<td>soajs.utilities/deployment/cloud/dashboard/controller/Dockerfile</td>
				</tr>
				<tr class="even">
					<td>Production</td>
					<td>soajs.utilities/deployment/cloud/prod/controller/Dockerfile</td>
				</tr>
			</tbody>
		</table>
		<br/>
		<pre><code class="bash"># on dashboard controllers machines
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/dashboard/controller/
$ docker-compose up

# on prod controllers machines
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/prod/controller/
$ docker-compose up</code></pre>
		<p>
			Docker will load the configuration file <b>docker-compose.yml</b> and install and run the controllers for you.<br/>
			<u>Note:</u> If you have chosen to install the controller via Docker, <a href="" ng-click="scrollToDiv('cloud-awareness-services', 70)">Click Here</a> to skip the manual installation of the controller and head to the next step.
		</p>
		<hr/>
		<br/>
		<h4>Manual Installation:</h4>

		<p>
			Similar to the above layer, we will set up 3 machines for dashboard controllers layer and 3 machines for production controllers layer.<br/>
			On each controller machine, install nodejs and HAproxy, then install the controller and the utilities of SOAJS.<br/>
			Execute the below commands in the terminal of each machine:
		</p>
		<pre><code class="bash"># install haproxy
$ apt-get install haproxy

# install nodejs
$ apt-get install nodejs

# create folder path to put all soajs components in it
$ mkdir -p /opt/soajs/node_modules/
$ mkdir -p /opt/soajs/logs
$ cd /opt/soajs/node_modules/

# install SOAJS controller and utilities
$ npm install soajs.controller
$ npm install soajs.utilities</code></pre>
		<p>
			Once the above are installed, first update the Haproxy configuration: <br/>
			<b>Dashboard Environment:</b><br/>
			Replace the file /etc/haproxy/haproxy.cfg with soajs.utilities/deployment/cloud/dashboard/controller/FILES/haproxy.cfg.
		</p>
		<pre><code class="bash"># replace haproxy.cfg
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/dashboard/controller/FILES/
$ cp haproxy.cfg /etc/haproxy/haproxy.cfg</code></pre>
		<p>
			<b>Production Environment:</b><br/>
			Replace the file /etc/haproxy/haproxy.cfg with soajs.utilities/deployment/cloud/prod/controller/FILES/haproxy.cfg.<br/>
		</p>
		<pre><code class="bash"># replace haproxy.cfg
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/prod/controller/FILES/
$ cp haproxy.cfg /etc/haproxy/haproxy.cfg</code></pre>
		<br/>
		<h4>Point out the Registry Profile</h4>

		<p>
			As mentioned in the <a href="#/documentation/core/registry">Registry</a>, SOAJS supports multiple projects, and in this case we need to use the dashboard project that contains the environment variables the dashboard environment and production project for production environment.<br/>
			The projects are located in soajs.utilities/deployment/cloud/profiles.<br/>
			On each controllers machines, create 3 environment variables and give them the following values:
		</p>
		<pre><code class="bash"># set the environment name
$ export SOAJS_ENV=prod

# set the project name
$ export SOAJS_PRJ=default

# point out the location of the project
$ export SOAJS_REGDIR=/opt/soajs/node_modules/soajs.utilities/deployment/cloud/profiles/</code></pre>
		<br/>
		<h4>Start the Controllers</h4>

		<p>
			Once the variables are created, start the controllers on all machines by executing the below command:
		</p>
		<pre><code class="bash"># start the controller on each machine
$ cd /opt/soajs/node_modules/soajs.controller
$ node .

# start haproxy
$ service haproxy start</code></pre>
		<p>
			<b>Note:</b> you can use <a href="https://www.npmjs.com/package/supervisor" target="_blank">supervisor</a> to run all the services in the background using one configuration file.<br/>
			Copy the configuration file supervisord.conf from soajs.utilities to /etc/supervisor/conf.d/ on each machine then run supervisor.
		</p>
		<pre><code class="bash"># copy configuration file for dashboard controllers
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/dashboard/controller/FILES/
$ cp supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# copy configuration file for production controllers
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/prod/controller/FILES/
$ cp supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# start the services via supervisor on all controllers machines
$ /usr/bin/supervisord</code></pre>
		<p>
			By now, Nginx and Controllers Layers are running, execute a heartbeat check on each controller by requesting the maintenance port:
		</p>
		<pre><code class="bash">$ curl -X GET "http://dashboard-api.soajs.org:5000/heartbeat"</code></pre>
		<h6>Response:</h6>
		<pre><code class="javascript">{"result":true,"ts":1427373613796,"service":{"service":"CONTROLLER","type":"rest","route":"/heartbeat"}}</code></pre>
		<p>
			You can perform the heartbeat check on the production controllers as well:
		</p>
		<pre><code class="bash">$ curl -X GET "http://api.soajs.org:5000/heartbeat"</code></pre>
		<h6>Response:</h6>
		<pre><code class="javascript">{"result":true,"ts":1427373613796,"service":{"service":"CONTROLLER","type":"rest","route":"/heartbeat"}}</code></pre>
	</div>
	<br/>
	<hr/>

	<h3 id="cloud-awareness-services">Services Layer</h3>

	<div>
		<h4>Docker:</h4>

		<p>
			As mentioned in the above Nginx layer docker installation, our team has prepared a docker image that contains all services installed and configured and ready to run to speed things up for you. Simply install NodeJs, Docker and Docker Compose on the machine, then using docker, install and
			run this layer. Once NodeJs, Docker and Docker-Compose are installed, install soajs.utilities to pull the configuration files:
		</p>
		<pre><code class="bash">$ cd /opt/soajs/node_modules/
$ npm install soajs.utilities</code></pre>
		<p>
			soajs.utilities contains 3 docker configuration files for the services:<br/>
		</p>
		<table width="100%" class="myTable">
			<thead>
				<tr>
					<th>Environment</th>
					<th>Services</th>
					<th>Docker File Path</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>Dashboard</td>
					<td>Urac - Dashboard</td>
					<td>soajs.utilities/deployment/cloud/dashboard/urac_dashboard/Dockerfile</td>
				</tr>
				<tr class="even">
					<td>Production</td>
					<td>Urac - oAuth</td>
					<td>soajs.utilities/deployment/cloud/prod/urac_oauth/Dockerfile</td>
				</tr>
				<tr>
					<td>Production</td>
					<td>Example01 - 02 - 03 - 04</td>
					<td>soajs.utilities/deployment/cloud/prod/examples/Dockerfile</td>
				</tr>
			</tbody>
		</table>
		<br/>
		<pre><code class="bash"># on dashboard services machines
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/dashboard/urac_dashboard/
$ docker-compose up

# on prod services machines
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/prod/urac_oauth/
$ docker-compose up

# on prod examples machines
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/prod/examples/
$ docker-compose up</code></pre>
		<p>
			Docker will load the configuration file <b>docker-compose.yml</b> and install and run the services for you.<br/>
			<u>Note:</u> If you have chosen to install the services via Docker, <a href="" ng-click="scrollToDiv('cloud-awareness-testing', 70)">Click Here</a> to skip the manual installation of the services and head to testing the services.
		</p>
		<hr/>
		<br/>
		<h4>Manual Installation:</h4>

		<p>
			Similar to above, create 3 machines for dashboard environment, 3 for production services environment and 3 others to run the examples and install the services needed on them. For Dashboard environment install both Urac and Dashboard services, for Production environment install both Urac
			and oAuth and for Examples installs the examples.<br/>
			On all 9 machines, install nodejs, soajs.utilities and soajs.urac by running the below commands:
		</p>
		<pre><code class="bash"># install nodejs
$ apt-get install nodejs

# create folder path to put all soajs components in it
$ mkdir -p /opt/soajs/node_modules/
$ mkdir -p /opt/soajs/logs/
$ cd /opt/soajs/node_modules/

# install soajs.utilities
$ npm install soajs.utilities

# install soajs.urac
$ npm install soajs.urac</code></pre>
		<p>
			Install the dashboard service on the machines that are used by the Dashboard environment by running the below command:
		</p>
		<pre><code class="bash">$ npm install soajs.dashboard</code></pre>
		<p>
			Install the oAuth and examples services on the machines that are used by the Production environment by running the below command:
		</p>
		<pre><code class="bash">$ npm install soajs.oauth

#install SOAJS examples
$ npm install soajs.examples</code></pre>
		<br/>
		<h4>Configuration:</h4>

		<p>
			Point out the data layer on all the services machines so that these services can communicate with the database when needed by editing the /etc/hosts file on each machine and adding the following entries:
		</p>
		<pre><code class="bash"># edit /etc/hosts of each Dashboard Services Machine
192.168.0.101 data_01</code></pre>
		<p>You will need to put the right IP addresses above.</p>
		<pre><code class="bash"># edit /etc/hosts of each Production Services Machines
192.168.0.101 data_01
192.168.0.102 data_02</code></pre>
		<p>You will need to put the right IP addresses above.</p>
		<br/>
		<h4>Point out the Registry Profile</h4>

		<p>
			Similar to what we did in the controller layer, we need to point out the correct project to use on the services machines. The projects are located in soajs.utilities/deployment/cloud/profiles/.<br/>
			On each machine, create 3 environment variables and give them the following values:
		</p>
		<pre><code class="bash"># set the environment name
$ export SOAJS_ENV=prod

# set the project name
$ export SOAJS_PRJ=default

# point out the location of the project
$ export SOAJS_REGDIR=/opt/soajs/node_modules/soajs.utilities/deployment/cloud/profiles/</code></pre>
		<br/>
		<h4>Start the Services</h4>

		<p>
			Once you completed all above steps, start haproxy and all the services in all machines:
		</p>
		<b>Urac Service:</b>
		<pre><code class="bash"># repeat the below command for all machines that have urac service
$ cd /opt/soajs/node_modules/soajs.urac
$ node .</code></pre>
		<br/>
		<b>Dashboard Service:</b>
		<pre><code class="bash"># repeat the below command for all machines that has dashboard service
$ cd /opt/soajs/node_modules/soajs.dashboard
$ node .</code></pre>
		<br/>
		<b>oAuth Service:</b>
		<pre><code class="bash"># repeat the below command for all machines that has oauth service
$ cd /opt/soajs/node_modules/soajs.oauth
$ node .</code></pre>

		<br/>
		<b>Examples Services:</b>
		<pre><code class="bash"># repeat the below command for all machines that has examples service
$ cd /opt/soajs/node_modules/soajs.examples/example01
$ node .
$ cd /opt/soajs/node_modules/soajs.examples/example02
$ node .
$ cd /opt/soajs/node_modules/soajs.examples/example03
$ node .
$ cd /opt/soajs/node_modules/soajs.examples/example04
$ node .</code></pre>
		<p>
			<b>Note:</b> you can use <a href="https://www.npmjs.com/package/supervisor" target="_blank">supervisor</a> to run all the services in the background using one configuration file.<br/>
			Copy the configuration file supervisord.conf to /etc/supervisor/conf.d/ then run supervisor.
		</p>
		<pre><code class="bash"># on dashboard machines copy configuration file from
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/dashboard/urac_dashboard/FILES/
$ cp supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# on production machines copy configuration file from
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/prod/urac_oauth/FILES/
$ cp supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# on production machines for examples copy configuration file from
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/cloud/prod/examples/FILES/
$ cp supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# start the services via supervisor on all machines
$ /usr/bin/supervisord</code></pre>
		<br/>
		<h4 id="cloud-awareness-testing">Testing the Services:</h4>

		<p>
			We mentioned in the <a href="#/documentation/services/controller">Controller</a> section that you can run a maintenance check on any service built with SOAJS. When a service starts, it will listen to two ports: the default port and the maintenance port.<br/>
			In the <a href="#/documentation/core/registry">registry</a> of SOAJS, the services are configured to run on specific port numbers.
		</p>
		<table width="100%" class="myTable">
			<thead>
				<tr>
					<td>Service&nbsp;Name</td>
					<td>Default&nbsp;Port</td>
					<td>Maintenance&nbsp;Port</td>
					<td>Operation</td>
				</tr>
			</thead>
			<tr class="odd">
				<td>Controller</td>
				<td>4000</td>
				<td>5000</td>
				<td>heartbeat</td>
			</tr>
			<tr class="even">
				<td>Urac</td>
				<td>4001</td>
				<td>5001</td>
				<td>heartbeat</td>
			</tr>
			<tr class="odd">
				<td>oAuth</td>
				<td>4002</td>
				<td>5002</td>
				<td>heartbeat</td>
			</tr>
			<tr class="even">
				<td>Dashboard</td>
				<td>4003</td>
				<td>5003</td>
				<td>heartbeat</td>
			</tr>
			<tr class="odd">
				<td>Example01</td>
				<td>4010</td>
				<td>5010</td>
				<td>heartbeat</td>
			</tr>
			<tr class="even">
				<td>Example02</td>
				<td>4011</td>
				<td>5011</td>
				<td>heartbeat</td>
			</tr>
			<tr class="odd">
				<td>Example03</td>
				<td>4012</td>
				<td>5012</td>
				<td>heartbeat</td>
			</tr>
			<tr class="even">
				<td>Example04</td>
				<td>4013</td>
				<td>5013</td>
				<td>heartbeat</td>
			</tr>
		</table>
		<p>
			Let's run some maintenance heartbeat requests to see the status of our services:
		</p>
		<pre><code class="bash">#
# Testing Dashboard services
#
$ curl -X GET "http://dashboard-api.soajs.org:5001/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"URAC","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://dashboard-api.soajs.org:5003/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"DASHBOARD","type":"rest","route":"/heartbeat"}}

#
# Testing Production services
#
$ curl -X GET "http://api.soajs.org:5001/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"URAC","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://api.soajs.org:5002/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"OAUTH","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://api.soajs.org:5010/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"EXAMPLE01","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://api.soajs.org:5011/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"EXAMPLE02","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://api.soajs.org:5012/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"EXAMPLE03","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://api.soajs.org:5013/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"EXAMPLE04","type":"rest","route":"/heartbeat"}}
		</code></pre>
	</div>
	<br/>
	<hr/>
	<h3>Data Layer</h3>

	<div>
		<p>
			Create 2 Machines and install mongodb on them; these machines will be used for each environment to install the databases and configuring them to work as replica sets.
		</p>
		<ol>
			<li><b>data_01</b>: contains provisioned information for tenants, products, environments, dashboard members and their sessions.</li>
			<li><b>data_02</b>: contains tenant specific information as well as any other additional custom services databases information.</li>
		</ol>
		<img ng-src="images/documentation/core-db-replica.png"/><br/>

		<p>
			You can always add additional nodes to distribute the load and expand. For this tutorial we chose to group CORE databases in one group <b>data_01</b> and the other databases in another group <b>data_02</b> resulting in two sets.
		</p>
		<pre><code class="bash">#install MongoDB latest stable version on each machine
$ apt-get install mongodb</code></pre>
		<p>
			Edit the hosts of each machine and point out the data layer hostnames:
		</p>
		<pre><code class="bash"># edit /etc/hosts of data_01
127.0.0.1 data_01</code></pre>
		<pre><code class="bash"># edit /etc/hosts of data_02
127.0.0.1 data_02</code></pre>

		<p>
			Once mongo is installed, create a replica set of 3 databases on each of these machines. If you are not familiar with Replica Sets, visit the official <a href="http://docs.mongodb.org/manual/tutorial/deploy-replica-set/" target="_blank">mongodb replica set documentation</a>.<br/>
			Install soajs.mongodb.data on data_01 and import the core sample data to the database.
		</p>
		<pre><code class="bash"># install nodejs
$ apt-get install nodejs

# create directory path
$ mkdir -p /opt/soajs/node_modules/
$ cd /opt/soajs/node_modules/

# install soajs.mongodb.data
$ npm install soajs.mongodb.data

# import the core sample data
$ cd soajs.mongodb.data/modules/dashboard-ui/
$ chmod +x import.sh
$ ./import.sh</code></pre>
		<p>
			The shell script will create 1 tenant, 1 product, 1 user and 1 group in our core database and will replicate the information on all members of the replica set. After executing the script connect to mongo and list the databases to verify that the last step imported the data:
		</p>
		<pre><code class="bash"># connect to mongo on data_01
$ mongo

# show the databases
mongo > show dbs
core_provision 0.078GB
local 0.078GB
dashboard_urac 0.078GB
admin (empty)

# switch to core_provision db
mongo > use core_provision

# list collections in the db
mongo > show collections
environment
oauth_token
oauth_urac
products
system.indexes
tenants</code></pre>
		<p>
			The above command will list the databases and the collections of core_provision inside data_01. This database information is used by SOAJS services and is considered as the core data. Dashboard services manage the data in these collections and Production services only read the
			information they need from them.
		</p>
	</div>
	<br/>
	<hr/>
	<h3>Summary</h3>

	<p>
		When completing the above deployment, your cloud will resemble the following diagram:<br/>
		<img ng-src="images/documentation/deployment-cloud3.png"><br/>
		Both environments have their servers and connect to their data layers, production environment should be able to connect to data_01 and read provisioned information.<br/>
	</p>
	<br/>
	<hr/>
	<h3>Your Service</h3>

	<p>
		Now that you have both environments set up, you can deploy your custom services in the production environment and add their databases in the data_02. Your custom services should be placed in the services layer next to Urac and oAuth.<br/>
		<img ng-src="images/documentation/deployment-cloud4.png"><br/>
		Just like the other services of SOAJS your service will manage its Data(if any) in data_02 and SOAJS framework inside your service as explained in the last section of <a href="#/documentation/deployment/overview">Architecture Overview</a> will read the provisioned information of your
		service(if any) from data_01.<br/>
		Don't forget to reload the registry and provisioning after you deploy your services so that the controllers learn of its presence. After you install your service on the production environment, run it, then run the following commands to reload both registry and provisioning:
	</p>
	<pre><code class="bash"># reload Registry
$ curl -X GET "http://api.soajs.org:5000/reloadRegistry"

# reload Provisioning
$ curl -X GET "http://api.soajs.org:5000/loadProvisioning"</code></pre>
	<p>
		Both maintenance operations have to be executed on the maintenance port of the controller, so that it can pick up the new configuration and direct the request that will be made to your service.<br/>Your service will be come accessible via the following URI:
		<a href="http://api.soajs.com/your_service/your_api" target="_blank">http://api.soajs.com/your_service/your_api</a>.
	</p>
	<br/>
	<hr/>
	<p>
		When the above steps are completed successfully, the cloud will be up and running, all services working and you can now login and use the interface. In your browser, open <a href="http://dashboard.soajs.org" target="_blank">http://dashboard.soajs.org</a>, login with username: <b>admin</b>
		and password: <b>password</b>.<br/>
		Once inside, change these credentials in Edit Profile section, you can also navigate through the sections of the dashboard to manage tenants, products and other information as explained in <a href="#/documentation/services/dashboard-service">Dashboard Services</a> and
		<a href="#/documentation/ui/dashboard-setup">Dashboard UI</a>.
	</p>
	<p>
		SOAJS is now running with all its services on your cloud, you can begin creating your services just like the examples are built. Create a folder for every service next to soajs.examples and add your code there. Check how to <a href="#/documenation/core/service">Create a service</a> in the documentation section and you can read more about the examples under <a href="#/getStarted">Get Started</a>.
	</p>
</div>