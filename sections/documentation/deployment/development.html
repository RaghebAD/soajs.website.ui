<a id="development"></a>
<h1>Development Environment</h1>
<div class="white-container">
	<p>
		In Development Environment, we deploying everything on a single machine. The below illustrates how to create an all in one development deployment. When deploying SOAJS on one machine some services and databases will be shared.<br />
		<img ng-src="images/documentation/deployment-aio.png" class="img-margin-t-b full-image" />
	</p>
	<br/>
	<hr/>
	<h3>Installation</h3>
	<p>
		You can install SOAJS and all its features on one machine either by using <a href="http://www.docker.com" target="_blank">Docker</a> or manually. We suggest you create the following folder schema to place SOAJS and its components:
	</p>
	<pre><code class="bash"># soajs modules go here
$ mkdir -p /opt/soajs/node_modules/

# soajs logs go here
$ mkdir -p $HOME/soajs/log</code></pre>
	<p>
		The above command will create a folder on the root level named <b>opt</b> with <b>soajs</b> folder inside it and <b>node_modules</b> folder inside <b>soajs</b>. When you install soajs in the next steps, all the core modules will be located in node_modules folder. This way when you create your services, simply require soajs in your code and it will be loaded.<br />
		The second folder schema will be used to write the services logs in it.<br />
		Now install soajs via one of the 2 methods below:<br /><br />
	</p>
	<h4>Docker:</h4>
	<p>
		Our team has prepared a docker image that contains all services installed and configured and ready to run to speed things up for you. Simply install docker on your machine, then run the image and the Development Environment of SOAJS will be downloaded and started on your machine.<br />
		Start by installing NodeJs then navigate to <a href="https://docs.docker.com/installation/" target="_blank">Docker Installation Page</a> and install docker and <a href="https://docs.docker.com/compose/" target="_blank">docker-compose</a> on the machine you are using. <br />
		Once NodeJs, Docker and Docker-Compose are installed, install soajs.utilities to pull the configuration files:
	</p>
		<pre><code class="bash">$ cd /opt/soajs/node_modules/
$ npm install soajs.utilities</code></pre>
	<p>
		Navigate to soajs.utilities/deployment/development/ and using docker-compose run the configuration file provided:
	</p>
	<pre><code class="bash">$ cd /opt/soajs/node_modules/soajs.utilities/deployment/development/
$ docker-compose up</code></pre>
	<p>
		Docker will load the configuration file <b>docker-compose.yml</b> and install the development environment of SOAJS on your machine, run the services and expose port 80 to your machine from the created container.<br />
		This means that when you attempt to hit <a href="http://api.soajs.org" target="_blank">http://api.soajs.org</a> or <a href="http://dashboard.soajs.org" target="_blank">http://dashboard.soajs.org</a> in your browser or via CURL, because port 80 is exposed, Nginx will reply and redirect your request to the services accordingly.<br />
	</p>
	<br/>
	<b>Data Layer:</b>
	<p>
		Docker will create a container for the database, SOAJS services will manage and read the data from this database.<br />
		To start, you need to import the provisioned data sample so you can login via the Dashboard UI and work.<br />
		This requires 2 steps, run the following to complete the setup of the database after Docker finishes the installation, then import the provisioned sample data to use the dashboard UI:
	</p>
	<div ng-init="loadBASH(path + 'deployment/development/dockerdb.tmpl','dockerdb');">
		<div id="dockerdb"></div>
	</div>
	<p>
		The above commands map both /data and /data/db directories from the container to your machine, this allows your services to communicate with the database. Then in step 2, we imported the sample data into the database by providing the ip address of the container where the database resides.
	</p>
	<fieldset>
		<legend>Mac OS X Machines:</legend>
		<div>
			<p>
				If your machine uses Mac OS X, then you need <a href="https://github.com/boot2docker/osx-installer/releases/latest" target="_blank">boot2docker</a> installed. Once boot2docker is installed, additional steps are required before executing the above mentioned commands to get the data layer working. Execute the below commands instead:
			</p>
	<pre><code class="bash"># ssh to boot2docker, create /data with the right permissions
$ boot2docker ssh
$ sudo mkdir -p /data
$ sudo chgrp staff -R /data
$ sudo chmod 775 -R /data

# step 1, complete data layer installation
$ docker run -p 27017:27017 -v /data:/data -v /data/db:/data/db mongo mongod --smallfiles

# step2, provision the sample data
$ cd /opt/soajs/node_modules/soajs.utilities/lib/
$ node index data import provision $(boot2docker ip)
$ node index data import urac $(boot2docker ip)</code></pre>
		</div>
	</fieldset>
	<p>
		All is installed and running, database provisioned with sample data, you can now start using SOAJS.<br />
		<u>Note:</u> If you have chosen to install SOAJS using Docker, <a href="" ng-click="scrollToDiv('aio-testing', 70)">Click Here</a> to skip the manual installation and head directly to testing the services.
	</p>
	<hr />
	<h4>Manual Installation:</h4>
	<p>
		You can always install SOAJS manually but this requires additional steps than Docker. Start by installing the technologies needed by SOAJS on your machine. Here are the steps you need to begin with:
	</p>
	<pre><code class="bash">#install MongoDB latest stable version
$ apt-get install mongodb

# install NodeJs latest stable version
$ apt-get install nodejs

# install Nginx latest stable version
$ apt-get install nginx</code></pre>
	<p>
		The next step requires we install the core components of soajs by running the following commands:
	</p>
	<pre><code class="bash">$ cd /opt/soajs/node_modules/

#install the controller
$ npm install soajs.controller

#install the urac
$ npm install soajs.urac

#install the dashboard
$ npm install soajs.dashboard

#install the oAuth service
$ npm install soajs.oauth

#install the examples
$ npm install soajs.examples

#install the utilities
$ npm install soajs.utilities
</code></pre>
	<p>
		When you are done with the NPM command above you should have a folder schema that resembles the following:
		<div ng-init="loadCode(path + 'deployment/development/folder-list.txt', 'folder-list');"></div>
		<div id="folder-list"></div>
	</p>
	<br/>
	<hr/>
	<h3>Configuration &amp; Startup</h3>
	<p>
		Whether you installed SOAJS via Docker or manually, here we focus on how to configure the components of SOAJS.<br />
	</p>
	<h4>Step 1: MongoDb</h4>
	<p>
		Let's start by running MongoDB, configure SOAJS registry to find it and thus connect to it and import some sample data to use later on. Open your terminal and start MongoDB:
		<pre><code class="bash">$ mongod</code></pre>
		The above step will start MongoDB on your local machine which becomes accessible via port 27017, then connect to the MongoDB server:
		<pre><code class="bash">$ mongo
$ mongo > show dbs</code></pre>
		The above 2 commands, connect to mongo and run command show databases which will list the database inside mongo. If any of the above command did not run or return the expected response, please make sure you installed MongoDB correctly or checkout the forums and troubleshooting sections of mongo on the <a href="http://www.mongodb.org" target="_blank">Official MongoDB Website</a>.<br /><br />

		Mongo runs by default on 127.0.0.1:27017 so we need to make sure that SOAJS connects to that ip address and that port when it wants to talk to mongo. Navigate to the profiles folder of SOAJS, you will find the default project there named <b>default</b>. If you do not know where the profiles folder resides, please read the <a href="#/documentation/core/registry">Registry</a> section. Inside the default project, there is a <b>configuration</b> folder that contains a file called <b>servers.js</b>. Edit that file and make sure that 127.0.0.1 is listed as a host entry and 27017 as a port in the servers array.
		<pre><code class="javascript">module.exports = {
	"prefix": "",
	"credentials": null,
	"servers": [
		{
			"host": "data-proxy",
			"port": 27017
		}
	]
};</code></pre>
		This file instructs SOAJS how to connect to mongo. You can always change the host/port values depending on where you installed mongodb and add credentials if needed or prefixes in the configuration.<br />
		Now let's import some data to the database so we can use them later on. Navigate to soajs.mongodb.data/modules/dashboard-ui/ and in your terminal execute the shell script <b>import.sh</b>, this script will create 1 tenant, 1 product, 1 user and 1 group. We will use this sample data later on when everything is running.
		<pre><code class="bash">$ cd /opt/soajs/node_modules/soajs.utilities/lib/
$ node index data import provision localhost
$ node index data import urac localhost</code></pre>
		Go back to the terminal where you connected to mongo, and run <b>show dbs</b> again, you will see that core_provision and dashboard_urac database in the list of databases.
		<pre><code class="bash">$ mongo > show dbs
core_provision  0.078GB
local           0.078GB
dashboard_urac  0.078GB
admin           (empty)

# switch to core_provision db
$ mongo > use core_provision

# list collections in the db
$ mongo > show collections
environment
oauth_token
oauth_urac
products
system.indexes
tenants
</code></pre>
		<em>core_provision database has 5 collections and the system.indexes, Great!.</em><br />
		We only configured one server in the servers list, our attempt is to configure Mongo to connect to one standalone server and not multiple servers. You can configure multiple servers for <a href="http://docs.mongodb.org/manual/replication" target="_blank">Replica Sets</a> and distribution the load; we will mention how to do that in the <a href="#/documentation/deployment/cloud-awareness">Cloud awareness</a> section while installing SOAJS on a cloud of nodes.<br />
		Mongo is now running, SOAJS is communicating with Mongo and the sample data is imported, let's configure the servers and services and start them.
	</p>
	<br/>
	<h4>Step 2: Nginx</h4>
	<p>
		We installed Nginx in the previous step, now we are going to configure it by pointing out the configuration files that SOAJS needs. To do that, first locate the Nginx configuration file on your machine:
		<pre><code class="bash">$ whereis nginx.conf</code></pre>
		By default on Ubuntu, nginx.conf is located in /etc/nignx/, copy the nginx configuration files from soajs.utilities to that location:
		<pre><code class="bash"># copy the upstream.conf
$ cp /opt/soajs/node_modules/soajs.utilities/deployment/development/nginx/FILES/nginx/upstream.conf /etc/nginx/conf.d/

# copy the hosts
$ cp /opt/soajs/node_modules/soajs.utilities/deployment/development/nginx/FILES/nginx/conf/*.conf /etc/nginx/sites-enabled/
</code></pre>
		Nginx will now load the configuration that SOAJS needs when started.<br />
		Edit your /etc/hosts file and add 2 entries to point out the required hosts:
		<pre><code class="javascript"># add the below in /etc/hosts
127.0.0.1   api.soajs.org
127.0.0.1   dashboard.soajs.org

127.0.0.1   service_proxy
127.0.0.1   data-proxy</code></pre>
		Go ahead and Start Nginx Now:
		<pre><code class="bash">$ sudo Nginx</code></pre>
		When Nginx starts, test the configuration you just created by opening your browser and invoking 2 domains: <b>api.soajs.org</b> and <b>dashboard.soajs.org</b>. Nginx will reply with a <b>502 Bad Gateway</b> Error instead of Server not Found. Till this point, this is normal because we haven't started any service yet, but the important thing is that Nginx is now redirecting the requests to a local SOAJS server assuming that the later is up and running.
	</p>
	<br/>
	<h4>Step 3: Point out the Registry Profile</h4>
	<p>
		The next step requires that you specify the path of the project to load the environment and registry information for the services to work. As mentioned in the <a href="#/documentation/core/registry">Registry</a>, SOAJS supports multiple projects, and in this case we need to use the default project that contains the environment variables that we need for the Development environment Setup. Navigate to soajs.utilities/deployment/development/profiles/.
	</p>
	<pre><code class="bash"># set the environment name to dev
$ export SOAJS_ENV=dev

# set the project name to default
$ export SOAJS_PRJ=default

# point out the location of the project
$ export SOAJS_REGDIR=/opt/soajs/node_modules/soajs.utilities/deployment/development/</code></pre>
	<p>
		The above variables will tell soajs the location of the profile you want to use and what is the environment and registry information that should be loaded.
	</p>
	<br/>
	<h4>Step 4: SOAJS Services</h4>
	<p>
		So far we configured all the prerequisites that SOAJS needs to work and tested them. Let's start the services one at a time:
		<pre><code class="bash">#navigate to soajs.controller in a new terminal
$ cd /opt/soajs/node_modules/soajs.controller
$ node .

#navigate to soajs.urac in a new terminal
$ cd /opt/soajs/node_modules/soajs.urac
$ node .

#navigate to soajs.oauth in a new terminal
$ cd /opt/soajs/node_modules/soajs.oauth
$ node .

#navigate to soajs.dashboard in a new terminal
$ cd /opt/soajs/node_modules/soajs.dashboard/service
$ node .

#navigate to soajs.examples and start the examples
$ cd /opt/soajs/node_modules/soajs.examples/
$ cd /example01
$ node .
$ cd /example02
$ node .
$ cd /example03
$ node .
$ cd /example04
$ node .</code></pre>
	When you run node . in every terminal you opened, you are starting the service. All the services are now running, let's make some test calls and when done, use the dashboard to login.
	</p>
	<p>
		<b>Note:</b> you can use <a href="https://www.npmjs.com/package/supervisor" target="_blank">supervisor</a> to run all the services in the background using one configuration file.<br />
		Copy the configuration file supervisord.conf to /etc/supervisor/conf.d/ then run supervisor.
		<pre><code class="bash"># copy configuration file
$ cd /opt/soajs/node_modules/soajs.utilities/deployment/development/service/FILES/
$ cp supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# start the services via supervisor
$ /usr/bin/supervisord</code></pre>
	</p>
	<br/>
	<h4 id="aio-testing">Step 5: Testing the services</h4>
	<p>
		We mentioned in the <a href="#/documentation/services/controller">Controller</a> section that you can run a maintenance check on any service built with SOAJS. When a service starts, it will listen to two ports: the default port and the maintenance port.<br />
		Let's run some maintenance heartbeat requests to see the status of our services:
		<pre><code class="bash"># in a new terminal
$ curl -X GET "http://127.0.0.1:5000/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"CONTROLLER","type":"rest","route":"/heartbeat"}}
</code></pre>
		We just ran a heartbeat check on the controller. The controller runs on port 4000 making his maintenance port 4000 + 1000 = 5000. Make a request to port 5000 followed by /hearbeat as a path parameter. You can perform the same operation for any other service. In the <a href="#/documentation/core/registry">registry</a> of SOAJS under dev environment, the services are configured to run on specific port numbers. The controller uses 4000, Urac 4001, oAuth 4002 and Dashboard 4003. This means their maintenance ports are equal to 5000, 5001, 5002, 5003. The same applies on the examples, their default ports are 4010, 4011, 4012, 4013 making their maintenance ports equal to 5010, 5011, 5012, 5013.<br />
		Let's run the heartbeat on every service other than the controller:
		<pre><code class="bash"># in the same terminal
$ curl -X GET "http://127.0.0.1:5001/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"URAC","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://127.0.0.1:5002/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"OAUTH","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://127.0.0.1:5003/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"DASHBOARD","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://127.0.0.1:5010/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"EXAMPLE01","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://127.0.0.1:5011/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"EXAMPLE02","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://127.0.0.1:5012/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"EXAMPLE03","type":"rest","route":"/heartbeat"}}

$ curl -X GET "http://127.0.0.1:5013/heartbeat"
{"result":true,"ts":1427373613796,"service":{"service":"EXAMPLE04","type":"rest","route":"/heartbeat"}}
</code></pre>
		HOUSTON WE HAVE LIFTOFF!!!
	</p>
	<br />
	<hr/>
	<p>
		Our services are healthy, up and running and we already imported the sample data to the database so let's stop with the curl commands and head on to the dashboard GUI, login and have some fun. In your browser, open <a href="http://dashboard.soajs.org" target="_blank">http://dashboard.soajs.org</a>, login with username: <b>admin</b> and password: <b>password</b>. Once inside, change these credentials in Edit Profile section, you can also navigate through the sections of the dashboard to manage tenants, products and other information as explained in <a href="#/documentation/services/dashboard-service">Dashboard Services</a> and <a href="#/documentation/ui/dashboard-setup">Dashboard UI</a>.<br /><br />
		SOAJS is now running with all its services on your machine, you can begin creating your services just like the examples are built. Create a folder for every service next to soajs.examples and add your code there. Check how to <a href="#/documenation/core/service">Create a service</a> in the documentation section and you can read more about the examples under <a href="#/getStarted">Get Started</a>.<br /><br />
		Whenever you finish a service simply run it and because you have to add an entry for it in the registry, execute the maintenance operation <b>reloadRegistry</b> just like you did for <b>heartbeat</b> above in the controller. The controller will reload the registry that contains your new service information and you service will be automatically detected and accessible via the controller.
		<pre><code class="bash">$ curl -X GET "http://127.0.0.1:5000/reloadRegistry"</code></pre>
		If your service also has provisioned information, like Example 02,03 and 04, you need to execute a second maintenance operation to load the new provisioned information.
		<pre><code class="bash">$ curl -X GET "http://127.0.0.1:5000/loadProvision"</code></pre>
		Both maintenance operations have to be executed on the maintenance port of the controller, so that it can pick up the new configuration and direct the request that will be made to your service.
		<img ng-src="images/documentation/deployment-aio2.png" class="img-margin-t-b  full-image" />
	</p>
</div>