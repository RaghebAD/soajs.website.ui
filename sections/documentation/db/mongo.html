<a id="mongo"></a>
<h1>Mongo Adapter</h1>
<div class="white-container">
    <p>
        SOAJS provides a MongoDB connector to communicate with the database. The Connector is capable of connecting to Static and Multitenant Databases and offers a simple interface to execute DB operations.
    </p>
    <table class="myTable" width="100%">
        <thead>
            <tr>
                <th>Connection Type</th>
                <th>Parameters</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr ng-class-even="'even'" ng-class-odd="'odd'" ng-repeat="conn in mongo.connections">
                <td>{{conn.type}}</td>
                <td>{{conn.params}}</td>
                <td ng-bind-html="conn.description"></td>
            </tr>
        </tbody>
    </table>
    <br/>
    <hr/>
    <h3>Connecting to the Database:</h3>
    <p>
        The database configuration is located in the <a href="#/documentation/core/registry">registry</a> and can be retrieved via <b>req.soajs.registry</b>. This information is then passed on to the Connector so that the later can communicate with Mongo DB. The following snippet shows the location of both static and multitenant database configurations inside the registry.
    </p>
    <div ng-init="loadCode(path + 'db/mongo/registry.js', 'mongo-registry');">
        <div id="mongo-registry"></div>
    </div>
    <br/>
    <h4>Static Database:</h4>
    <p>
        The below examples shows how to connect to <b>staticdb</b> who is a static database from the list above, and retrieve some records. The configuration of this database is located under <b>coreDB</b> object:
    </p>
    <pre><code class="javascript">//require soajs and initialize a service
var soajs = require('soajs');
var service = new soajs.server.service({...});
service.init(function(){

    //add an api
    service.get("/someAPIroute", function(req, res){

        //fetch the db configuraiton
        var dbConfig = req.soajs.registry.coreDB.staticdb;

        //create a new connection
        var mongo_connector = new soajs.mongo(dbConfig);

        //get records from collection
        mongo_connector.find('mycollection', {}, function(error, records){ ..... });

    });

    service.start();
});
</code></pre>
    <br/>
    <h4>Multitenant Database:</h4>
    <p>
        Multitenant databases names are dependent on the tenant code: %TENANT_CODE% + dbName.<br />
        Therefore additional steps are required to establish a connection to these databases.
    </p>
    <ol>
        <li>Get the Registry DB Info => <b>req.soajs.registry.tenantMetaDB</b></li>
        <li>Get the Tenant Code => <b>req.soajs.tenant.code</b></li>
        <li>Build the DB Configuration using => <b>req.soajs.meta.tenantDB</b></li>
        <li>Connect to Mongo by providing the DB Configuration</li>
    </ol>
    <p>
        The below examples shows how to connect to a multitenant database <b>multitenantdb</b> from the list above, and retrieve some records:
    </p>
    <pre><code class="javascript">//require soajs and initialize a service
var soajs = require('soajs');
var service = new soajs.server.service({...});

service.init(function(){

    //add an api
    service.get("/someAPIroute", function(req, res){

        //fetch the registry info
        var dbRegistry = req.soajs.registry.tenantMetaDB;

        //fetch the tenant code
        var tenantCode = req.soajs.tenant.code;

        //build the db configuration for multitenant databases
        var dbConfig = req.soajs.meta.tenantDB(dbRegistry, "multitenantdb", tenantCode);

        //create a new connection
        var mongo_connector = new soajs.mongo(dbConfig);

        //get records from collection
        mongo_connector.find('mycollection', {}, function(error, records){ ..... });

    });

    service.start();
});
</code></pre>
    <br/>
    <hr/>
    <h3>Database Operations</h3>
    <p>
        SOAJS Mongo Driver allows you to perform database operations to store, retrieve and remove information from the database.<br />
        The below table list the available operations and their usage:
    </p>
    <fieldset ng-repeat="op in mongo.operations">
        <legend>{{op.method}}</legend>
        <p ng-bind-html="op.description"></p>
        <div ng-if="op.params">
            <b>Parameters</b>
            <table class="myTable" width="100%">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Order</th>
                        <th>Type</th>
                        <th>Mandatory</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="param in op.params" ng-class-even="'even'">
                        <td>{{param.name}}</td>
                        <td>{{$index}}</td>
                        <td>{{param.type}}</td>
                        <td>{{param.mandatory}}</td>
                    </tr>
                </tbody>
            </table>
            <br/>
            <div ng-repeat="(mode, code) in op.code track by mode">
                <b>{{mode}}</b><br />
                <pre><code class="javascript" ng-bind-html="code"></code></pre>
            </div>
        </div>
    </fieldset>
</div>