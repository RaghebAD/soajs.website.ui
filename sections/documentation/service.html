<a id="service"></a>
<h1>SOAJS Service</h1>

<div class="white-container">
    Building a service with <b>SOAJS</b> is straight forward; Start by installing <b>SOAJS</b> via npm:
	<pre>
		<code class="bash">$ npm install soajs</code>
	</pre>
	Once installed, a directory called <b>node_modules</b> will be created and <b>SOAJS</b> will be located inside it.<br />
	Create your service next to the <b>node_modules</b> directory:<br />
    <img ng-src="images/documentation/service-folder-tree.png" align="right" class="image-border img-margin-l-b"/>
    <ol>
        <li>Create a directory and name it as your service.<br/><u>Ex:</u> <span style="color:red;">"example01"</span>.</li>
        <li>Create 2 files in that directory:
            <ol>
                <li><u><b>index.js</b></u> used to write your the code of the service APIs.</li>
                <li><u><b>config.js</b></u> used for <b>IMFV</b> and custom service configuration.</li>
            </ol>
        </li>
    </ol>
    <hr/>
    <br/>
    Navigate to the <a href="" ng-click="loadSection('registry');">Registry</a> of <b>SOAJS</b> and add an entry for your service under the <a href="" ng-click="loadSection('registry', 'rest-apis');">REST
    API Configuration</a>.<br/>
    Configure your service in the registry by specifying:
    <ol>
        <li>The host and port that the service is listening on.</li>
        <li>If it requires a key to be accessible or not (<b>boolean</b>).</li>
    </ol>
	<u>Note:</u> Setting <b>extKeyRequired</b> value to true means that this service requires a tenant key to be accessible. All requests to this service should include the tenant key in the headers, otherwise the service will not be invoked.
	<br><br><u>Ex:</u><br>
    <img src="images/documentation/registry-example01.png" class="image-border img-margin-t-b"/><br/><br/>
    <p>
        <em>
            Img 1. shows a standard entry in registry.<br/>
	        The Service named example01 does not require a tenant key to be accessible, runs on port 4010 and the host is rest-proxy.<br />
	        Access this service is made through the controller which runs on port 4000 followed by the name of the service as a path parameter.
        </em><br/>
    </p>
    <hr/>
    <h4><u>Basic Example:</u></h4>

    <p>
        The following example demonstrates how to write a service with <b>SOAJS</b> that has one route using the GET protocol.
        The service reads 2 inputs from the query string of the request, puts them in a JSON object and returns the object in the response.<br/><br/>
        <img src="images/documentation/example01.png" align="right" class="image-border img-margin-l-b padding-0"/>
	    <!-- to do: update image -->
    </p>

    <p>

    <h3><b>Code walkthrough:</b></h3>
    <ul>
        <li><b>Line1-</b> "strict mode” JavaScript.</li>
        <li><b>Line2-</b> Require <b>SOAJS</b> framework.</li>
        <li><b>Line3-</b> Require local configuration file.</li>
        <li><b>Line4-</b> Create a service using <b>SOAJS</b>.<br/><br/><br/></li>
        <li><b>Line5-</b> Create api <b style="color:red;">“/testGet”</b> that uses the GET protocol. It takes a function with two input objects: the request <b>req</b>, and the response <b>res</b>. A <b>SOAJS</b> object is added to the <b>req</b>.</li>
        <li><b>Line6-</b> The api returns a json response. It uses the <b>SOAJS</b> object added to the <b>req</b> to build the json response (through <b>“req.soajs.req.buildResponse”</b>) and captures the passed params to the api from (<b>“req.soajs.inputmaskData”</b>).
        </li>
        <li><b>Line11-</b> Start the service.</li>
    </ul>
    </p>
    <br/>
	<p><a href="#/getStarted/example01">Example01</a> demonstrates how to create a service and provides examples on how to call it.</p>
    <hr/>
    <br/>
    <tabset>
        <tab heading="index.js">
            <br />
	        <div ng-init="loadCode(path + 'service/index.js', 'indexjs');"></div>
	        <div id="indexjs"></div>
        </tab>
        <tab heading="registry" select="">
            <br />
	        <div ng-init="loadCode(path + 'service/registry.js', 'registryjs');"></div>
	        <div id="registryjs"></div>
        </tab>
        <tab heading="config.js">
            <br />
            <p>
                Config.js is discussed in details in <a href="" ng-click="loadSection('imfv','example');">IMFV</a> section.
            </p>
            <br /><br />
        </tab>
    </tabset>
    <script>renderCodeSnippets();</script>
	<hr/>
	<br/>
	<h3>Starting the Service:</h3>
	<p>
		Before starting any service, install the <a href="#" ng-click="loadSection('imfv','controller');">Controller</a> of <b>SOAJS</b> and run it. All requests to <b>SOAJS</b> services pass through the controller first for clearance checking. To access a service, both the controller and the service should be running.<br /><br/>

		<b>soajs.util</b> is the main utility module for <b>SOAJS</b> and contains the controller. Install this module via NPM and start the controller within it, then navigate to your service and run it.
		<pre><code class="bash">$ npm install soajs.util
$ cd soajs.util/controller/
$ node index

$ cd ../example01
$ node index</code>
		</pre>
		Your service is now running on the port you have assigned to it in the registry as explained at the top of the page.
		You can access your service by hitting the url of the controller followed by the name of your service and its API.
		<pre>
			<code class="bash">$ curl -X GET "http://localhost:4000/example01/testGet</code>
		</pre>
		The above snippet illustrates that the controller runs by default on <u>localhost</u> port <u>4000</u>.
		Your service name is added as a path parameter to the request and followed by the API it contains that you are trying to hit. <br/>
	</p>
	<hr/>
	<h3>Maintenance Check:</h3>
	<p>
		By default, the controller runs on your localhost via port 4000. Every service in <b>SOAJS</b> has its own default port and another maintenance port configured in the registry. So when you start a service, the service will be listening to two ports at the same time; one to process the requests and another used for maintenance operations.<br />
	</p>
	<fieldset>
		<legend>Controller Default Port</legend>
		<div>
			<pre><code class="bash">$ curl -X GET "http://localhost:4000</code></pre>
			<h6><u>Response:</u></h6>
						<pre><code class="bash">{
	"result": false,
		"errors": {
			"codes": [ 130 ],
			"details": [
				{
					"code": 130,
					"message": "Unknown service."
				}
			]
	}
}</code></pre>
			<em>When you invoke the controller on the default port and without specifying a service, the controller simply returns an error message.</em>
			<p><br/>On its own, the controller is useless but in this case, we just wanted to check that there is a response and verify that it is running and listening on port 4000.</p>
		</div>
	</fieldset>
	<p>
		You can access the maintenance port while the service is running and perform some maintenance operations like heartbeat checking and reload configuration. To access the maintenance port of a service, add 1000 to its default port number, in this case 4000 + 1000 = 5000.<br/>
	</p>
	<fieldset>
		<legend>Controller Maintenance Port</legend>
		<div>
			<p>Let's hit the maintenance port and perform a heartbeat check.<br /></p>
			<pre><code class="bash">$ curl -X GET "http://localhost:5000/heartbeat</code></pre>
			<h6><u>Response:</u></h6>
						<pre><code class="bash">{
	"result": true,
		"ts": 1425041775082,
		"service": {
		"service": "CONTROLLER",
		"type": "rest",
		"route": "/heartbeat"
	}
}</code></pre>
			<em>You can perform a heartbeat check on any service using this approach. Simply call the maintenance port of a service and invoke the "/heartbeat" api to check if it is running.</em>
			<p><br/>Great! the service is healthy and running as expected.</p>
		</div>
	</fieldset>
	<fieldset>
		<legend>Heartbeat Your Service</legend>
		<div>
			At the begining, we showed a snippet where we chose to configure our service to run on port 4010.
			<pre>
				<code class="bash">$ curl -X GET "http://localhost:5010/heartbeat"</code></pre>
			<h6><u>Response:</u></h6>
				<pre><code class="bash">{
"result":true,
	"ts":1425054123486,
	"service": {
		"service":"example01",
		"type":"rest",
		"route":"/heartbeat"
	}
}</code>
				</pre>
			<p>Notice here that we used port <u>5010</u> to perform a <b>heartbeat</b> check. A heartbeat operation is made using the maintenance port of a service which is equal to the port number of the service + 1000.<br />
				In the image above, in <b>Registering the Service</b>, we registered example01 in <b>SOAJS</b> with port <u>4010</u> making the maintenance port of this service <u>5010</u>.</p>
		</div>
	</fieldset>
	<fieldset>
		<legend>Calling Your Service</legend>
		<div>
			<pre><code class="bash">$ curl -X GET "http://localhost:4000/example01"</code></pre>
			<h6><u>Response:</u></h6>
				<pre><code class="bash">{
	"result":false,
		"errors": {
			"codes": [ 151 ],
			"details": [
			{
				"code": 151,
				"message": "You are trying to reach an unknown rest service!"
			}
		]
	}
}</code>
				</pre>
			<p>
				Here we attempted to call <b>Example01</b> service without specifying any of its APIs. The returned response was a fail because basically there is no API defined in this service with to handle route "/" so this event is treated as if an invalid API route was called.<br /><br />
				Another important thing to notice is how the URL of the service was constructed. Again, all requests to <b>SOAJS</b> services pass through the <a href="#/documenation/controller">Controller</a> and this why the port used was <u>4000</u> and not <u>4010</u> even though <u>4010</u> is <b>Example01</b> service port in the registry.
			</p>
		</div>
	</fieldset>
	<fieldset>
		<legend>Calling <b>testGet</b> API in Your Service</legend>
		<div>
			<pre><code class="bash">$ curl -X GET "http://localhost:4000/example01/testGet?firstName=John&lastName=Smith&email=john@smith.com" </code> </pre>
			<h6>Response</h6>

			<div ng-init="loadJson(path + 'service/result02.json', 'result02js');">
				<div id="result02js"></div>
			</div><br />
			<p>This time the API returned a valid response with the JSON Object containing all the parameters we specified.</p>
		</div>
	</fieldset>
	<hr/>
	<p>
		Checkout <a href="#/getStarted">Get Started</a> Section along with the examples it offers to learn how to download the examples and run them and how to make calls to services, check if they are healthy, secure them and productize them.
	</p>
</div>