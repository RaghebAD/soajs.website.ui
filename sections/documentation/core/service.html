<a id="service"></a>
<h1>SOAJS Service</h1>
<div class="white-container">
    Building a service with SOAJS is straight forward; Start by installing SOAJS via npm:
	<pre><code class="bash"># create a directory for soajs
$ mkdir -p /opt/soajs/node_modules/

# install soajs
$ npm install soajs</code></pre>
	Create your service next to the <b>node_modules</b> directory:<br />
	<pre><code class="bash">$ mkdir /opt/soajs/myService/</code></pre>
    <ol>
        <li>Create 2 files in that directory:
            <ol>
                <li><u><b>index.js</b></u> used to write your the code of the service APIs.</li>
                <li><u><b>config.js</b></u> used for <a href="#/documentation/core/imfv">IMFV</a> and custom service configuration.</li>
            </ol>
        </li>
    </ol>
	<pre><code class="bash">$ cd /opt/soajs/
$ ll -la
drwxr-xr-x   8 admin  root   272 Mar 20 17:56 .
drwxr-xr-x   9 admin  root   306 Mar 25 14:06 ..
drwxr-xr-x  12 admin  root   408 Mar 24 11:08 node_modules
drwxr-xr-x  12 admin  root   408 Mar 24 11:08 myService

#list myService
$ ll -la myService
drwxr-xr-x  12 admin  root   408 Mar 24 11:08 .
drwxr-xr-x   8 admin  root   272 Mar 20 17:56 ..
-rw-r--r--   1 admin  root   612 Mar 24 14:40 config.js
-rw-r--r--   1 admin  root   612 Mar 24 14:40 index.js

#list node_modules folder
$ ll -la node_modules
drwxr-xr-x  12 admin  root   408 Mar 24 11:08 .
drwxr-xr-x   8 admin  root   272 Mar 20 17:56 ..
drwxr-xr-x  18 admin  root   612 Mar 24 14:40 soajs</code></pre>
    <hr/>
    <h3>Basic Example</h3>

    <p>
        The following code snippet shows how to write a service with SOAJS that has one route using the GET protocol. The service reads 2 inputs from the query string of the request, puts them in a JSON object and returns the object in the response. This code is found in the index.js of a service that you created in the above step.<br />
	    The second file config.js, contains the service information such as name and the port number the service will run on.
    </p>
	<tabset>
		<tab heading="index.js">
			<pre><code class="javascript">'use strict';
var soajs = require('soajs');
var config = require('./config.js');
var service = new soajs.server.service(config);
service.init(function() {
	service.get("/hello", function(req, res) {
		var name = req.soajs.inputmaskData.firstName + " " + req.soajs.inputmaskData.lastName;
		res.json(req.soajs.buildResponse(null, "Hello " + name));
	});
	service.start();
});</code></pre>
			<h4>Code walkthrough</h4>
			<ul class="codeList">
				<li><b>Line1-</b> "strict mode” JavaScript.</li>
				<li><b>Line2-</b> Require SOAJS framework.</li>
				<li><b>Line3-</b> Require local configuration file.</li>
				<li><b>Line4-</b> Create a service using SOAJS.<br/></li>
				<li><b>Line5-</b> Initialize the Service.</li>
				<li><b>Line6-</b> Create API <b style="color:red;">“/hello”</b> that uses protocol GET. API takes two parameters: request - response.</li>
				<li><b>Line7-</b> Create variable "name" that formulates a string from the received inputs: firstName - lastName.</li>
				<li><b>Line8-</b> The api returns a json response using SOAJS <a href="#/documentation/core/response">buildResponse</a>.</li>
				<li><b>Line10-</b> Start the service.</li>
			</ul>
		</tab>
		<tab heading="config.js">
			<pre><code class="javascript">'use strict';
module.exports = {
	"serviceVersion": 1,
	"serviceName": "helloworld",
	"serviceGroup": "SOAJS Example Services",
	"servicePort": 4020,
	"requestTimeout": 30,
	"requestTimeoutRenewal": 5,
	"awareness": true,
	"extKeyRequired": false,
	"oauth": false,
	"errors": { "400": "please provide a firstName and a lastName" },
	"schema": {
		"/hello": {
			"_apiInfo":{ "l": "hello world" },
			"firstName": { "source": ["query.firstName"], "required": true, "validation": {"type": "string"}},
			"lastName": { "source": ["query.lastName"], "required": true, "validation": {"type": "string"}}
		}
	}
};</code></pre>
			<h4>Code walkthrough</h4>
			<ul class="codeList">
				<li><b>Line1-</b> "strict mode” JavaScript.</li>
				<li><b>Line2-</b> export the JSON object when this file is required.</li>
				<li><b>Line3-</b> specify the service version.</li>
				<li><b>Line4-</b> specify the service name.</li>
				<li><b>Line5-</b> specify the service group.</li>
				<li><b>Line6-</b> specify the service port.<br/></li>
				<li><b>Line7-</b> specify how long (in seconds) to wait for a response before a request to the service api times out.</li>
				<li><b>Line8-</b> specify the number of attempts, in case of a timeout, before considering the service api unreachable.</li>
				<li><b>Line9-</b> if the awareness is enable, the service becomes aware of the controller's location.</li>
				<li><b>Line10-</b> specify if the service is <a href="#/documentation/advanced/multitenant">multitenant</a>.</li>
				<li><b>Line11-</b> specify if the service should be protected by <a href="#/documentation/services/oauth">oAuth</a>.</li>
				<li><b>Line12-</b> Object containing the error codes of this service.</li>
				<li><b>Line13-</b> Object containing service APIs schema.</li>
				<li><b>Line14-</b> First API whose route value is /hello.</li>
				<li><b>Line15-</b> API Information containing the label representation; displayed in <a href="#/documentation/ui/dashboard">Dashboard UI</a>.</li>
				<li><b>Line16 & 17-</b> API parameters firstName and lastName used by <a href="#/documentation/core/imfv">IMFV</a></li>
			</ul>
		</tab>
	</tabset>
	<hr/>
	<h3>Configuration Options</h3>
	<p>
		The following tables explains the list of properties that can be added to the configuration object.
		<table class="myTable">
			<thead>
				<tr>
					<th style="min-width: 50px;">Property Name</th>
					<th>Description</th>
					<th style="min-width: 42px;">Default Value</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><b>extKeyRequired</b></td>
					<td>soajs evolves the service and makes it multitenant supportive.<br />
						- The service thus can be used by multiple tenants and is only accessible when a tenant key is provided <a href="#/documentation/advanced/multitenant">Read&nbsp;More</a><br />
						- Key security is turned on; device and geo information can be configured <a href="#/documentation/core/key-security">Read&nbsp;More</a><br />
						- If configured, SOAJS will also be able to compare the access to the requested service APIs<a href="#/documentation/core/acl">Read&nbsp;More</a><br />
					</td>
					<td>FALSE</td>
				</tr>
				<tr class="even">
					<td><b>session</b></td>
					<td>If set to true, SOAJS creates a persistent session and adds it to the request object.</td>
					<td>FALSE</td>
				</tr>
				<tr>
					<td><b>oauth</b></td>
					<td>if set to true, the service becomes protected by oauth. Only requests that have a valid access_token are permitted to use the APIs of this service. <a href="#/documentation/services/oauth">Read&nbsp;More</a></td>
					<td>FALSE</td>
				</tr>
				<tr class="even">
					<td><b>bodyParser</b></td>
					<td>soajs parses the body to json allowing it to extend it and add its functionality and data to it.</td>
					<td>TRUE</td>
				</tr>
				<tr>
					<td><b>methodOverride</b></td>
					<td>soajs provides the ability to use PUT and DELETE in HTTP requests where the request doesn't support it by default.</td>
					<td>TRUE</td>
				</tr>
				<tr class="even">
					<td><b>cookieParser</b></td>
					<td>soajs parses cookies from the request consolidates them under one object "cookies" and attaches them to the request object. </td>
					<td>TRUE</td>
				</tr>
				<tr>
					<td><b>logger</b></td>
					<td>soajs gives you the ability to have unified and standardized api logging (error, debug, info, …). With the power of soajs.agent, the unified logging will be fed into elastic search and the soajs.dashboard.ui to give you amazing analytic information.</td>
					<td>TRUE</td>
				</tr>
				<tr class="even">
					<td><b>inputmask</b></td>
					<td>soajs makes it easy by consolidating all the api params from multiple source(post, get, cookie, headers, session, provisioning, …) under one object after formatting and validation.  <a href="#/documentation/core/imfv">Read&nbsp;More</a></td>
					<td>TRUE</td>
				</tr>
			</tbody>
		</table>
		<pre>
			<code class="javascript">// example of a full configuration object
var config = {
	"serviceVersion": 1,
	"serviceName": "helloworld",
	"serviceGroup": "SOAJS Example Services",
	"servicePort": 4020,
	"requestTimeout": 30,
	"requestTimeoutRenewal": 5,
	"awareness": true,
	"extKeyRequired": true,
	"oauth": true,
	"session": true,
	"errors": { "400": "please provide a firstName and a lastName" },
	"schema": { }
};
module.exports = config;</code></pre>
		<u>Note:</u> Notice that bodyParser, methodOverride, cookieParser, logger and inputmask are not added to the configuration. By default, these properties are set to TRUE if not provided. To disabled their usage, add them to the object declaration and set their values to FALSE.
	</p>
	<hr/>
	<h3>Starting the Service</h3>
	<p>
		Every service created with SOAJS is implemented using <a href="http://www.nodejs.org" target="_blank">NodeJs</a> therefore start the service using node in a terminal:
		<pre><code class="bash">$ cd /opt/soajs/myService/
$ node index</code></pre>
		Your service will run and will be listening on the port specified in config.js which in this case is 4020. Your service will also be listening on a second port used for maintenance purposes. That port is equal to the default port specified in config.js + 1000 and in this case has the value of 5020. Once your service is running, make a call via CURL like the following:
		<pre><code class="bash">$ curl -X GET "http://127.0.0.1:4020/hello?firstName=John&lastName=Doe"</code></pre>
	</p>
	<hr/>
	<h3>Calling the Service</h3>
	<p>
		Now that the service is running, we will make 3 calls:
	</p>
	<ol>
		<li><b>Heartbeat:</b> test that the service is healthy.</li>
		<li><b>Default Port:</b> make a call to the service without specifying any API.</li>
		<li><b>Call Service API:</b> call the API of the service and pass the parameters to it.</li>
	</ol>
	<fieldset>
		<legend>Heartbeat Your Service</legend>
		<div>
			<p>
				As mentioned in the above section, a maintenance port is used to perform maintenance operations such as checking if a service is healthy which in this case it's called "heartbeat".
			</p>
			<pre><code class="bash">$ curl -X GET "http://127.0.0.1:5020/heartbeat"</code></pre>
			<h6><u>Response:</u></h6>
			<pre><code class="bash">{
	"result":true,
	"ts":1425054123486,
	"service": {
		"service":"HELLOWORLD",
		"type":"rest",
		"route":"/heartbeat"
	}
}</code></pre>
		</div>
	</fieldset>
	<fieldset>
		<legend>Calling Your Service</legend>
		<div>
			<pre><code class="bash">$ curl -X GET "http://127.0.0.1:4020"</code></pre>
			<h6><u>Response:</u></h6>
			<pre><code class="bash">{
	"result":false,
	"errors": {
		"codes": [ 151 ],
		"details": [
			{
				"code": 151,
				"message": "You are trying to reach an unknown rest service!"
			}
		]
	}
}</code></pre>
			<p>
				Here we attempted to call the service without specifying its API. The returned response was a fail because basically there is no point in calling a service with asking for any of its APIs.
			</p>
		</div>
	</fieldset>
	<fieldset>
		<legend>Calling the API in Your Service</legend>
		<div>
			<pre><code class="bash">$ curl -X GET "http://127.0.0.1:4020/hello?firstName=John&lastName=Doe"</code></pre>
			<h6>Response</h6>
			<pre><code class="javascript">{
	"result": true,
	"data": "Hello John Doe"
}</code></pre>
			<p>This time the API returned a valid response with the JSON Object containing all the parameters we specified.</p>
		</div>
	</fieldset>
	<hr/>
	<p>
		Checkout <a href="#/getStarted">Get Started</a> Section along with the examples it offers to learn how to create basic services, protect them, make them multitenant and benefit from the tons of features SOAJS offers.
	</p>
</div>