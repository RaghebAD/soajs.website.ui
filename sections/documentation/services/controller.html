<a id="soajs.controller"></a>
<h1>SOAJS Controller</h1>
<div class="white-container">
	<p>
		SOAJS Controller is the main gateway to its cloud of service APIs.<br/>
		All requests are made to this gateway first and then forwarded based on the route requested after clearance checking.
	</p>
	<hr/>
	<h3>Features</h3>
	<ol>
		<li>
			<u><b>Self Awareness:</b></u>
			<p>
				The controller's main functionality is to provide awareness among the services in SOAJS's cloud. The controller also sends heartbeat checks on a regular basis to all registered services in SOAJS. If any of these services is down, the controller will know and will notify you immediately.
			</p>
			<p>
				You can have multiple controllers running in a cloud, Should one go down, the others remain functional and your cloud remains accessible and working. Controllers also distribute the load on the services; if you have 3 controllers where each controller forwards requests to 3 instances of a service, then your cloud performance will highly increase and traffic handling becomes faster.
			</p>
		</li>
		<li>
			<u><b>Request Handling:</b></u>
			<p>
				Before redirecting to the requested service, the controller checks if the service is alive and running. If a service is down or does not exist, the controller will return a message back to the sender without crashing. When a new service is created or added to the cloud, the controller will detect its presence. All requests to this new service will then be forwarded.
			</p>
			<p>
				The Controller runs on port <b>4000</b>. To request a service in the cloud, simply add the service name after the port number as a path parameter. To request a specific API in that service, type the route path after the service name.
				<u>Ex:</u>
			</p>
			<pre><code class="bash">#CURL -X %method% http:// %controller host% : 4000 / %service name% / %route path% /
CURL -X POST "http://127.0.0.1:4000/urac/login"</code></pre>
			<em>The above example calls SOAJS's Controller, then requests the urac service and route login.</em>
		</li>
		<li>
			<u><b>CORS:</b></u><br/>

			<p>
				SOAJS controller also provides support for <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing" target="_blank">CORS</a> (Cross Origin Resource Sharing).<br />
				Enabling <b>CORS</b> allows different domains to communicate with SOAJS via its gateway to post and pull resources without having to deal with <b>"cross-domain"</b> issues and by simply using the standard protocols: GET - POST - DELETE - PUT.
			</p>
		</li>
	</ol>
	<br/>
	<hr/>
	<h3>Usage</h3>

	<p>
		SOAJS controller is located in <a href="https://npmjs.com/packages/soajs.controller" target="_blank">soajs.controller</a>.
	</p>
	<pre><code class="bash">$ cd /opt/soajs/node_modules/
$ npm install soajs.controller
$ cd soajs.controller
$ node .</code></pre>
	<br/>
	<hr/>
	<h3>Testing the Service</h3>

	<p>
		The controller runs on port 4000. Every service in SOAJS has its own default port and another maintenance port configured in the registry. So when you start a service, the service will be listening to two ports at the same time; one to process the requests and another used for maintenance operations. You can access the maintenance port while the service is running and perform some maintenance operations like heartbeat checking and reload configuration. To access the maintenance port of a service, add 1000 to its default port number, in this case 4000 + 1000 = 5000. Let's see what happens when we run both 4000 and 5000 ports on your machine.
	</p>
	<fieldset>
		<legend>Default Port</legend>
		<div>
			<pre><code class="bash">$ curl -X GET "http://127.0.0.1:4000</code></pre>
			<h6><u>Response:</u></h6>
			<pre><code class="bash">{
	"result": false,
	"errors": {
		"codes": [ 130 ],
		"details": [
			{
				"code": 130,
				"message": "Unknown service."
			}
		]
	}
}</code></pre>
			<em>When you invoke the controller on the default port and without specifying a service, the controller simply returns an error message.</em>

			<p>
				On its own, the controller is useless. When you create a service, run both the controller and the service then call the controller on the default port followed by the service name and the service API as path parameters so that the service responds.<br/>
				Link Schema: http://<b>%controller%</b> / <b>%service name%</b> / <b>%api%</b><br/>
				<u>Ex:</u> <a href="http://127.0.0.1:4000/example01/testGet?name=johnDoe" target="_blank">http://127.0...1:4000/example01/testGet?name=johnDoe</a><br/>
				<em>127.0.0.1:4000 here represents the address of the controller.<br/>
					example01 is the name of the service.<br/>
					testGet is the api we are calling.
				</em>
			</p>
		</div>
	</fieldset>
	<fieldset>
		<legend>Maintenance Port with Operation</legend>
		<div>
			<p>Let's hit the maintenance port and perform a heartbeat check.<br/></p>
			<pre><code class="bash">$ curl -X GET "http://127.0.0.1:5000/heartbeat</code></pre>
			<h6><u>Response:</u></h6>
			<pre><code class="bash">{
	"result": true,
	"ts": 1425041775082,
	"service": {
		"service": "CONTROLLER",
		"type": "rest",
		"route": "/heartbeat"
	}
}</code></pre>
			<em>You can perform a heartbeat check on any service using this approach. Simply call the maintenance port of a service and invoke the "/heartbeat" api to check if it is running.</em>

			<p>Great! the service is healthy and running as expected.</p>
		</div>
	</fieldset>
	<hr/>
	<h3>Maintenance Operations</h3>
	<p>
		You can perform different maintenance operations on a service by calling the maintenance port and specifying the maintenance operation using the this approach. The below table shows what maintenance operations can be applied to the services of SOAJS including the controller:
	</p>
	<table class="myTable" width="100%">
		<thead>
			<tr>
				<th>Operation Name</th>
				<th>Controller</th>
				<th>Description</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>heartbeat</td>
				<td>YES</td>
				<td>Perform a heartbeat test on the running service to determine if it is healthy and running.</td>
			</tr>
			<tr class="even">
				<td>reloadRegistry</td>
				<td>YES</td>
				<td>Reload and pull a new version of the Registry information from the database.</td>
			</tr>
			<tr>
				<td>awarenessStat</td>
				<td>YES</td>
				<td>Perform awareness check on a SOAJS services, this operation is only executed by the controller and is repeated on a regular basis based on the awareness timeout value configured in the registry of the running environment.</td>
			</tr>
			<tr class="even">
				<td>loadProvision</td>
				<td>NO</td>
				<td>Reload and pull a new version of the provisioned information from the database, this operation is executed by all SOAJS services except the controller since the later does not require provisioned information to be running.</td>
			</tr>
		</tbody>
	</table>
	<script>renderCodeSnippets();</script>
</div>