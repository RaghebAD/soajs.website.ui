<div class="page" ng-controller="example03Ctrl">
	<div class="main-section-container examples">
		<a href="#/getStarted" class="goBackLink">Go Back</a>

		<h1>Example 04</h1>
		<hr/>
		In <a href="#/getStarted/example02">Example02</a> we used <b>oAuth</b> to secure our service, and in <a href="#/getStarted/example03">Example03</a> we examined how to secure a service per tenant.

		In this example we will show you that you can use <b>oAuth</b> together with multitenancy.
		Everything is similar to Example03 with few exceptions.
		<!-- <img ng-src="images/getstarted/example03.png" style="margin:5px 0;"/> -->

		<hr/>
		<h3><u>Import Provisioning</u></h3>
		<p>
			In <a href="#/getStarted/example03">Example03</a>, we provisioned some data in order to test the service.
			If you modified the data in the database, we suggest you repeat the provisioning step.
			If the data in the database is still intact, skip this step.<br/><br/>
		</p>
		<hr/>

		<h3><u>Start the Service</u></h3>
		We already have both the controller and Urac services running, and the provision data is imported.
		All we need now is to start <b>Example04</b>:
		<pre><code class="bash">#start example04
$ cd soajs.examples/examples04
$ node index</code></pre>
		<p>
			<b>Example04</b> is now running on http://localhost:4000/example04.<br/>
			                 Let's do a heartbeat check just to make sure all is working as expected before we begin the tests.<br/><br/>
		</p>

		<fieldset>
			<legend>Heartbeat Example04</legend>
			<div>
				<pre><code class="bash">$ curl -X GET "http://localhost:5013/heartbeat"</code></pre>
				<h6><u>Response:</u></h6>

				<div ng-init="loadJSON(path + 'example04/heartbeat_example04.json', 'heartbeat_example04');">
					<div id="heartbeat_example04"></div>
				</div>
				<p>Example04 is registered in <b>SOAJS</b> with port <u>4013</u> making the maintenance port of this service as <u>5013</u>.
				   As you can see, the service is running.
				</p>
			</div>
		</fieldset>
		<hr/>
		<h3><u>What has changed:</u></h3>

		<br>
		<h4><u>The Product:</u></h4>
		<br/>
		We applied a modification to the product record <b>PROD1</b>.
		<div ng-init="loadCode(path + 'example04/product1.js', 'product1');">
			<div id="product1"></div>
		</div>
		<br>
		We added "oauth" and "example04" services to the acl of the first package.
		Now this package has access to them, and we can use them in our example.
		<br/>
		<em>Note that the sample data has not actually changed in the provisioned product record.
		    If you had inspected the database while testing Example03 you would have seen it,
		    but we chose to ignore it in Example03.</em>
		<hr/>
		<h4><u>The Tenant:</u></h4>
		<br>
		Nothing to change for the tenant.
		<div ng-init="loadCode(path + 'example03/tenant1.js', 'tenant1');">
			<div id="tenant1"></div>
		</div>

		<br>
		<h3><u>Service Code:</u></h3>
		The code is similar to that in <b>Example03</b>.
		We only need to edit the service config in <u>index.js</u> file; add the "oauth" entry and set it to true as shown below.
		Now the service is secured by <b>oAuth</b>.
		<tabset>
			<tab heading="index.js"><br/>
				<div ng-init="loadCode(path + 'example04/index.js', 'indexjs');"></div>
				<div id="indexjs"></div>
			</tab>
			<tab heading="config.js" select=""><br/>

				<div ng-init="loadCode(path + 'example04/config.js', 'configjs');"></div>
				<div id="configjs"></div>
			</tab>
		</tabset>
		<br>

		<hr/>

		We are ready to run the tests.
		We will repeat some tests for Tenant 1. Just replace "example03" by "example04". <br/><br/>
		<fieldset>
			<legend>Tenant 1: 1st Application</legend>
			<div>
				<em>The tenant's first application uses <b>PROD1_PCK1</b> package, which has "example04" in its ACL.</em>
				<br>
				We will try to hit "example04/buildName" using the external key of the first app from the first tenant:<br/>
				<pre><code class="bash">$ curl -X GET -H "key:4232477ed993d167ec13ccf8836c29c400fef7eb3d175b1f2192b82ebef6fb2d129cdd25fe23c04f856157184e11f7f57b65759191908cb5c664df136c7ad16a56a5917fdeabfc97c92a1f199e457e31f2450a810769ff1b29269bcb3f01e3d2" "http://rest-proxy:4000/example04/buildName?lastName=Smith"
				</code></pre>
				<h6>Response:</h6>

				<div ng-init="loadJSON(path + 'example04/tenant1_test1.json', 'tenant1_test1');">
					<div id="tenant1_test1"></div>
				</div>
				Access denied! We need to login with oauth first.
			</div>
		</fieldset>
		<fieldset>
			<legend>Login to oAuth</legend>
			<div> Like in <a href="#/getStarted/example02">Example02</a>, login to oAuth. <em>Again, using the key from Tenant 1 first application</em><br/>
				<pre><code class="bash">$ curl -X POST -H "Authorization: Basic MTBkMmNiNWZjMDRjZTUxZTA2MDAwMDAxOnNoaGggdGhpcyBpcyBhIHNlY3JldA==" -H "key:4232477ed993d167ec13ccf8836c29c400fef7eb3d175b1f2192b82ebef6fb2d129cdd25fe23c04f856157184e11f7f57b65759191908cb5c664df136c7ad16a56a5917fdeabfc97c92a1f199e457e31f2450a810769ff1b29269bcb3f01e3d2" "http://localhost:4000/oauth/token" -d 'username=oauthuser_tenant1&password=oauthpassword_tenant1&grant_type=password'</code></pre>
				<h6>Response:</h6>

				<div ng-init="loadJSON(path + 'example04/oauth_login.json', 'oauth_login');">
					<div id="oauth_login"></div>
				</div>
			      Like in Example02, the login to <b>oAuth</b> returned a token value. We need to add this <b>access_token</b> value to the consequent api calls.

			</div>
		</fieldset>


		<fieldset>
			<legend>Call Api again with oAuth token</legend>
			<div>
				We will hit "example04/buildName" again with access_token as an additional query parameter:
				<pre><code class="bash">$ curl -X GET -H "key:4232477ed993d167ec13ccf8836c29c400fef7eb3d175b1f2192b82ebef6fb2d129cdd25fe23c04f856157184e11f7f57b65759191908cb5c664df136c7ad16a56a5917fdeabfc97c92a1f199e457e31f2450a810769ff1b29269bcb3f01e3d2" "http://rest-proxy:4000/example04/buildName?lastName=Smith&access_token=e58751473112bca2ed939e0445e55b0f7921f544"</code></pre>
				<h6>Response:</h6>
				<div ng-init="loadJSON(path + 'example04/response1.json', 'response1');">
					<div id="response1"></div>
				</div>
				Success! <em> </em>
				<br>
			</div>
		</fieldset>
		<p>
			Try to repeat any of the tests we ran on Tenant 1 in <a href="#getStarted/example03">Example03</a>.
			You need to attach the <b>access_token</b> parameter to all your calls to reach the <b>Example04</b> service.
		</p>

	</div>
	<script>renderCodeSnippets();</script>
</div>