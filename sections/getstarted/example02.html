<div class="examples">
	<a id="top"></a><h1>Example 02</h1>
	<div class="white-container">
		<p>
			In the previous example, we showed you how to do a heartbeat check on a service we provided you with some sample tests you can run and see how the service responds to different scenarios and how <a href="#/documentation/core/imfv">IMFV</a> works. Now we are going to take one of the APIs from <a href="#/getStarted/example01">Example01</a> and use it in this example but we will secure this service via <a href="http://oauth.net/" target="_blank">oAuth</a>. When securing a service with oAuth, the service becomes accessible only to logged in oAuth users. Every request made to the service is first validated by SOAJS <a href="#/documentation/services/oauth">oAuth Service</a> before it gets forwarded to that service. We previously installed <a href="https://www.npmjs.org/packages/soajs.oauth" target="_blank">soajs.oauth</a> in <a href="#/getStarted">Get Started</a> and turned it on so let's turn on example02 and run some tests on its APIs.
		</p>
		<hr/>
		<h3>Start the Service</h3>
		<p>
			Start <b>Example02</b> service just like you did in <b>Example01</b>:
		</p>
		<pre><code class="bash">$ cd /opt/soajs/node_modules/soajs.examples/example02/
$ node index</code></pre>
		<p>
			<b>Example02</b> is configured to run on http://127.0.0.1:4011.<br />
			Let's do a heartbeat check just to make sure all is working as expected before we begin the tests.<br /><br />
		</p>
		<fieldset><legend>Heartbeat oAuth</legend><div class="insideFieldsetMain">

		<div>
			<pre><code class="bash">$ curl -X GET "http://127.0.0.1:5002/heartbeat"</code></pre>
			<h6><u>Response:</u></h6>
			<pre><code class="bash">{
	"result":true,
	"ts":1425131003103,
	"service": {
		"service":"oauth",
		"type":"rest",
		"route":"/heartbeat"
	}
}</code>
			</pre>
			<p>
				Notice here that we used port <u>5002</u> to perform a <b>heartbeat</b> check. We previously mentioned in <a href="#/getstarted">Get Started</a>, that a heartbeat operation is made using the maintenance port of a service and that the maintenance port is equal to the port number of the service + 1000. Since oAuth service runs on port <u>4002</u> this makes its maintenance port equal to <u>5002</u>.
				</p>
			</div>
		</div>
		</fieldset>
		<fieldset><legend>Heartbeat Example02</legend><div class="insideFieldsetMain">

			<div>
				<pre><code class="bash">$ curl -X GET "http://127.0.0.1:5011/heartbeat"</code></pre>
				<h6><u>Response:</u></h6>
				<pre><code class="bash">{
	"result":true,
	"ts":1425131238011,
	"service": {
		"service":"example02",
		"type":"rest",
		"route":"/heartbeat"
	}
}</code>
				</pre>
				<p>
					As mentioned above, Example02 in SOAJS runs on port <u>4011</u> making the maintenance port of this service as <u>5011</u> and as you can see, when we performed a heartbeat operation, we got a healthy response back.
				</p>
			</div></div>
		</fieldset>
		<hr/>
		<h3>Running Some Tests</h3>
		<br/>
		<fieldset><legend>Calling Example02</legend><div class="insideFieldsetMain">
			<div>
				<pre><code class="bash">$ curl -X GET "http://127.0.0.1:4011"</code></pre>
				<h6><u>Response:</u></h6>
				<pre><code class="bash">{
	result: false,
	errors: {
		codes: [ 400 ],
		details: [ { code: 400, message: "The access token was not found" } ]
	}
}</code>
				</pre>
				<p>
					We just made a call to <b>Example02</b> service without specifying any access_token and we already checked that the service is running when we performed a heartbeat operation. But the service returned a fail response. Basically we are not doing anything wrong here, we are simply showing that to access this service, you need to provide an access_token from oauth service otherwise SOAJS will no allow you to go forward.
				</p>
			</div></div>
		</fieldset>
		<fieldset><legend>Login to oAuth</legend>
			<div class="insideFieldsetMain">
				<div>
					<p>
					Login to oAuth and get the access_token. The <b>oauth/token</b> API takes 3 input params from the posted body: [ "username" - "password" - "grant_type" ]. Notice how we added the <b>key</b> and the <b>Authorization</b> values in the header of the request. The Key in header represents a tenant key and is explained in detail in <a href="#/documentation/advanced/multitenancy">Multitenancy</a> section in documentation. The Authorization in header is used by oAuth to validate both posted body and is explained in detail in <a href="#/documentation/services/oauth">oAuth</a> section under documentation.
					</p>
					<pre><code class="bash">$ curl -X POST -H "Authorization: Basic MTBkMmNiNWZjMDRjZTUxZTA2MDAwMDAxOnNoaGggdGhpcyBpcyBhIHNlY3JldA==" -H "key:aa39b5490c4a4ed0e56d7ec1232a428f771e8bb83cfcee16de14f735d0f5da587d5968ec4f785e38570902fd24e0b522b46cb171872d1ea038e88328e7d973ff47d9392f72b2d49566209eb88eb60aed8534a965cf30072c39565bd8d72f68ac" "http://127.0.0.1:4002/token" -d 'username=oauthuser&password=oauthpassword&grant_type=password'</code></pre>
					<h5>Response:</h5>
					<div ng-init="loadJSON(path + 'example02/loginReturn.json', 'loginReturn');">
						<div id="loginReturn"></div>
					</div>
					We can now use this <b>access_token</b> in the consequent requests to access <b>Example02</b> APIs.
				</div>
			</div>
		</fieldset>
		<fieldset><legend>Call Example02 API Again</legend><div class="insideFieldsetMain">
			<div>
				The <b>access_token</b> we obtained from the previous login request should be appended it to all consequent API calls made to this service in order to be authorized and accessible. Call the api with the <b>access_token</b> as an additional query parameter:<br>
			<pre><code class="bash">$ curl -X GET "http://127.0.0.1:4011/buildName?firstName=John&lastName=Smith&access_token=e58751473112bca2ed939e0445e55b0f7921f544"</code></pre>
			<h6>Response</h6>
			<div ng-init="loadJSON(path + 'example02/oauth_token.json', 'oauth_token');">
				<div id="oauth_token"></div>
			</div>
				Notice here that the call we made to <b>Example02</b> only require we provide an <b>access_token</b> as a <b>querystring</b> parameter along with the other inputs. SOAJS will check the <b>access_token</b> provided. If valid, the request is forwarded to the service and in this case we got a valid response.
				</div>
			</div>
		</fieldset>
		<hr />
		<h3>Code Explaination</h3>
		<p>
			The code of service <b>Example02</b> resembles <a href="#/getStarted/example01">Example01</a> with the exception of oauth being set to true in the constructor. This change only happened in index.js as demonstrated in the below snippets.
		</p>

		<tabset>
			<tab heading="index.js"><br/>
				<div ng-init="loadCode(path + 'example02/index.js', 'indexjs');"></div>
				<div id="indexjs"></div>
			</tab>
			<tab heading="config.js"><br/>
				<div ng-init="loadCode(path + 'example02/config.js', 'configjs');"></div>
				<div id="configjs"></div>
			</tab>
		</tabset>
		<br>
		<p>The above API, takes 2 parameters from the query string, concatenates them and returns them in a JSON response.</p>
		<hr />
		<p>
			As you can see it takes little effort to secure your service with oAuth. You only needed to start oAuth service, login and use the token in the requests made to the protected service. You can secure any service in SOAJS by just turning on the oAuth property to "true" while creating this service. The rest is handled by SOAJS magic.<br />
			Try to conduct additional tests and scenarios on <b>Example02</b> APIs and oAuth. When you are ready to jump to the next level.
		</p>
		<div style="clear:both; width:100%; display: table;">
			<a class="small-button" href="#/getStarted/example03">Next &raquo;</a>
		</div>
	</div>
	<script>renderCodeSnippets();</script>
</div>